{% extends "base.html" %}

{% block title %}GPU 监控 - GPU 服务器管理系统{% endblock %}
{% block page_title %}GPU 监控{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-6">
        <select class="form-select" id="serverSelect" onchange="loadGPUInfo()">
            <option value="">请选择服务器...</option>
        </select>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-primary" onclick="loadGPUInfo()">
            <i class="bi bi-arrow-clockwise"></i> 刷新
        </button>
        <button class="btn btn-success" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
            <i class="bi bi-play-fill"></i> 自动刷新
        </button>
    </div>
</div>

<!-- GPU统计概览 -->
<div id="gpuStats" class="mb-3"></div>

<!-- GPU卡片网格 -->
<div id="gpuContainer"></div>

<style>
.gpu-compact-card {
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
}
.gpu-compact-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
}
.gpu-stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0.25rem 0;
}
.gpu-stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
}
.gpu-progress-mini {
    height: 8px;
    margin-top: 0.5rem;
}
.stat-card {
    border-left: 4px solid;
}
.stat-card.stat-idle { border-left-color: #28a745; }
.stat-card.stat-busy { border-left-color: #ffc107; }
.stat-card.stat-full { border-left-color: #dc3545; }

/* GPU 卡片内统一字体大小和间距 */
.gpu-compact-card .card-body {
    display: flex;
    flex-direction: column;
}
.gpu-compact-card .card-body > div {
    margin-bottom: 0.5rem;
}
.gpu-compact-card .card-body > div:last-child {
    margin-bottom: 0;
    margin-top: auto; /* 进程按钮固定在底部 */
}
.gpu-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 20px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval = null;
let selectedServer = null;
const GPU_IDLE_THRESHOLD = 50; // MB

async function loadServers() {
    const result = await utils.apiRequest('/api/servers');
    if (result.success) {
        const select = document.getElementById('serverSelect');
        select.innerHTML = '<option value="">请选择服务器...</option>' +
            result.servers
                .filter(s => s.gpu_enabled)
                .map(s => `<option value="${s.name}">${s.name} (${s.host})</option>`)
                .join('');
    }
}

async function loadGPUInfo() {
    selectedServer = document.getElementById('serverSelect').value;
    if (!selectedServer) {
        document.getElementById('gpuContainer').innerHTML =
            '<div class="alert alert-info">请选择一个 GPU 服务器</div>';
        return;
    }

    document.getElementById('gpuContainer').innerHTML =
        '<div class="text-center"><div class="spinner-border"></div></div>';

    const result = await utils.apiRequest(`/api/gpu/${selectedServer}`);

    if (!result.success) {
        document.getElementById('gpuContainer').innerHTML =
            `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${result.error}</div>`;
        return;
    }

    renderGPUs(result.gpus);
}

function renderGPUs(gpus) {
    if (gpus.length === 0) {
        document.getElementById('gpuContainer').innerHTML =
            '<div class="alert alert-warning">未检测到 GPU</div>';
        return;
    }

    // 计算统计信息（显存占用 < 50MB 视为空闲）
    const stats = {
        total: gpus.length,
        idle: gpus.filter(g => g.memory_used < GPU_IDLE_THRESHOLD).length,
        busy: gpus.filter(g => g.memory_used >= GPU_IDLE_THRESHOLD && g.memory_percent < 90).length,
        full: gpus.filter(g => g.memory_percent >= 90).length
    };

    // 渲染统计卡片
    const statsHtml = `
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card stat-idle">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="gpu-stat-label">空闲</div>
                                <div class="gpu-stat-number text-success">${stats.idle}</div>
                            </div>
                            <i class="bi bi-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card stat-busy">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="gpu-stat-label">使用中</div>
                                <div class="gpu-stat-number text-warning">${stats.busy}</div>
                            </div>
                            <i class="bi bi-activity" style="font-size: 2rem; color: #ffc107;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card stat-full">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="gpu-stat-label">高负载</div>
                                <div class="gpu-stat-number text-danger">${stats.full}</div>
                            </div>
                            <i class="bi bi-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="gpu-stat-label">总计</div>
                                <div class="gpu-stat-number text-primary">${stats.total}</div>
                            </div>
                            <i class="bi bi-gpu-card" style="font-size: 2rem; color: #007bff;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('gpuStats').innerHTML = statsHtml;

    // 紧凑网格布局 - 保持每行列数一致
    const html = `
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3">
            ${gpus.map(gpu => {
                // 判断 GPU 状态：空闲（显存<50MB）、高负载（>=90%）、使用中
                const isIdle = gpu.memory_used < GPU_IDLE_THRESHOLD;
                const isFull = gpu.memory_percent >= 90;
                const borderClass = isIdle ? 'border-success' : (isFull ? 'border-danger' : '');
                const headerBg = isIdle ? 'success' : (isFull ? 'danger' : 'primary');

                return `
                <div class="col">
                    <div class="card gpu-compact-card ${borderClass}">
                        <div class="card-header bg-${headerBg} text-white py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small><strong>GPU ${gpu.id}</strong></small>
                                <span class="badge bg-light text-dark" style="font-size: 0.65rem;">
                                    ${isIdle ? '空闲' : (isFull ? '高负载' : '使用中')}
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <div class="text-truncate mb-2" title="${gpu.name}" style="min-height: 32px;">
                                <small style="font-size: 0.75rem; line-height: 1.2;">${gpu.name.split(' ').slice(-2).join(' ')}</small>
                            </div>

                            <div class="gpu-info-row mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-thermometer-half"></i> ${gpu.temperature}°C
                                </small>
                                <small class="text-muted">
                                    <i class="bi bi-speedometer2"></i> ${gpu.utilization}%
                                </small>
                            </div>

                            <div class="mb-2">
                                <div class="gpu-info-row">
                                    <small class="text-muted"><strong>显存:</strong></small>
                                    <small class="text-muted">${gpu.memory_percent}%</small>
                                </div>
                                <div class="progress gpu-progress-mini">
                                    <div class="progress-bar ${gpu.memory_percent > 90 ? 'bg-danger' : gpu.memory_percent > 70 ? 'bg-warning' : 'bg-success'}"
                                         style="width: ${gpu.memory_percent}%"></div>
                                </div>
                                <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">
                                    ${gpu.memory_used} / ${gpu.memory_total} MB
                                </small>
                            </div>

                            <div class="mt-auto">
                                <button class="btn btn-sm btn-outline-secondary w-100 py-1" onclick="loadProcesses(${gpu.id})" style="font-size: 0.75rem;">
                                    <i class="bi bi-list"></i> 查看进程
                                </button>
                                <div id="processes-${gpu.id}" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('')}
        </div>
    `;

    document.getElementById('gpuContainer').innerHTML = html;
}

async function loadProcesses(gpuId) {
    const container = document.getElementById(`processes-${gpuId}`);
    container.innerHTML = '<div class="spinner-border spinner-border-sm" style="width: 1rem; height: 1rem;"></div>';

    const result = await utils.apiRequest(`/api/gpu/${selectedServer}/processes?gpu_id=${gpuId}`);

    if (!result.success) {
        container.innerHTML = `<small class="text-danger">${result.error}</small>`;
        return;
    }

    if (result.processes.length === 0) {
        container.innerHTML = '<small class="text-muted">无进程</small>';
        return;
    }

    const html = `
        <div style="font-size: 0.7rem;">
            ${result.processes.map(p => `
                <div class="border-top pt-1 mt-1">
                    <div><strong>PID:</strong> ${p.pid}</div>
                    <div><strong>显存:</strong> ${p.mem} MB</div>
                </div>
            `).join('')}
        </div>
    `;
    container.innerHTML = html;
}

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');

    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        btn.innerHTML = '<i class="bi bi-play-fill"></i> 自动刷新';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
    } else {
        autoRefreshInterval = setInterval(loadGPUInfo, 5000);
        btn.innerHTML = '<i class="bi bi-stop-fill"></i> 停止刷新';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
        utils.showAlert('已启动自动刷新 (5秒间隔)', 'success');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadServers();
});
</script>
{% endblock %}
