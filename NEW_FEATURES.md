# 新增功能说明

## ✨ 本次更新内容

### 1. 🔐 安全增强：高危操作密码验证

**功能描述：**
所有危险操作（如删除用户、删除容器等）现在需要输入管理员密码才能执行。

**使用方式：**
- 删除用户时，系统会弹出密码验证对话框
- 输入正确的管理员密码后才能继续操作
- 默认管理员密码在 `.env` 文件中配置（`ADMIN_PASSWORD`）

**安全建议：**
```bash
# 修改 .env 文件中的默认密码
vi .env

# 修改这一行：
ADMIN_PASSWORD=your-strong-password-here
```

**影响的操作：**
- ✅ 删除用户
- ✅ 删除 Docker 容器（rm 操作）
- 🔜 将来可扩展到其他高危操作

---

### 2. 🔍 一键测试所有服务器连接

**功能描述：**
新增"一键测试所有连接"按钮，可以同时测试所有配置的服务器是否可以正常连接。

**使用方式：**
1. 进入**"服务器管理"**页面
2. 点击右上角的 **"一键测试所有连接"** 按钮
3. 等待测试完成（通常几秒钟）
4. 查看测试结果汇总表格

**测试结果包含：**
- ✅ 连接成功的服务器数量
- ❌ 连接失败的服务器及错误信息
- 📊 每台服务器的详细状态

**应用场景：**
- 系统启动后快速验证所有服务器连接
- 排查网络问题
- 验证新添加的服务器配置

---

### 3. 🎯 任务监控全面升级

#### 3.1 三步向导式创建流程

**原有方式：**
需要手动填写 PID、服务器名称等信息

**现在的方式：**
- **步骤 1：** 选择服务器
- **步骤 2：** 查看 GPU 状态，选择要监控的进程
- **步骤 3：** 填写任务名称和邮件通知

#### 3.2 实时 GPU 状态展示

**功能描述：**
选择服务器后，立即显示所有 GPU 的实时状态：
- GPU 温度
- GPU 使用率
- 显存使用情况（百分比和具体数值）

**界面示例：**
```
GPU 0: NVIDIA GeForce RTX 3090
🌡️ 45°C  | ⚡ 32%
████████░░ 显存: 12288/24576 MB (50%)
```

#### 3.3 自动检测并列出 GPU 进程

**功能描述：**
系统会自动扫描服务器上所有正在使用 GPU 的进程，显示详细信息：

| 列 | 说明 |
|---|-----|
| GPU | 进程所在的 GPU 编号 |
| PID | 进程 ID（自动检测） |
| 进程名 | 程序名称 |
| 显存 | 占用的显存大小 |
| 用户 | 运行进程的用户 |
| 启动时间 | 进程启动的时间 |

**使用方式：**
- 直接勾选要监控的进程（支持多选）
- 点击"全选"可以一次性监控所有进程
- PID 会自动填充到任务信息中

#### 3.4 邮箱地址自动记忆

**功能描述：**
输入一次邮箱地址后，系统会自动保存，下次创建任务时自动填充。

**数据存储：**
- 保存在 `data/user_prefs.json` 文件中
- 支持多个邮箱地址（逗号分隔）
- 可以随时修改

**隐私说明：**
- 数据仅存储在本地服务器
- 不会发送到外部

#### 3.5 批量创建监控任务

**功能描述：**
可以同时选择多个进程，系统会为每个进程自动创建独立的监控任务。

**示例：**
选择 3 个进程，任务名称填写 "ResNet训练"，则会创建：
- ResNet训练 (PID: 12345)
- ResNet训练 (PID: 12346)
- ResNet训练 (PID: 12347)

---

## 🚀 使用演示

### 场景：监控深度学习训练任务

**步骤 1：进入任务监控页面**
```
访问: http://localhost:5000/tasks
点击: 新建任务监控
```

**步骤 2：选择服务器**
```
从下拉列表选择: GPU Server 1 (202.117.43.222)
→ 自动进入下一步
```

**步骤 3：查看 GPU 和选择进程**
```
GPU 状态:
  GPU 0: RTX 3090 | 温度 45°C | 使用率 85%
  GPU 1: RTX 3090 | 温度 42°C | 使用率 12%

运行中的进程:
  ☑ GPU 0 | PID: 23456 | python train.py | 8192 MB | user1 | Sat Nov 17 10:23:45
  ☐ GPU 1 | PID: 23789 | python test.py  | 2048 MB | user2 | Sat Nov 17 11:15:23

→ 勾选要监控的进程，点击"下一步"
```

**步骤 4：填写信息**
```
任务名称: ResNet 训练任务
监控的 PID: 23456 (自动填充)
通知邮箱: your-email@example.com (首次填写后会记住)
超时时间: 86400 秒 (24小时)

→ 点击"创建监控任务"
```

**步骤 5：等待通知**
```
任务完成后，您会收到邮件通知：

主题: ✅ [GPU Server 1] 任务通知: ResNet 训练任务
内容:
  任务名称: ResNet 训练任务
  服务器: GPU Server 1
  状态: 成功完成
  任务 PID: 23456
  完成时间: 2025-11-17 15:30:00
```

---

## 🔧 技术实现

### 后端 API 新增

```python
# 1. 密码验证
POST /api/auth/verify
Body: { "password": "admin123" }

# 2. 一键测试所有服务器
GET /api/servers/test-all

# 3. 获取所有 GPU 进程
GET /api/gpu/<server_name>/all-processes

# 4. 用户偏好设置
GET /api/prefs
POST /api/prefs
```

### 前端组件更新

```javascript
// 全局密码验证函数
utils.requirePasswordForDangerousAction(callback)

// 用户偏好管理
utils.loadUserPrefs()
utils.saveUserPrefs(prefs)
```

---

## 📝 配置说明

### 管理员密码配置

```bash
# 编辑 .env 文件
vi .env

# 添加或修改：
ADMIN_PASSWORD=your-secure-password

# 重启应用生效
./start.sh
```

### 服务器配置示例

```yaml
# config/servers.yaml
servers:
  - name: "GPU Server 1"
    host: "202.117.43.222"
    port: 2233
    username: "lthpc"
    password: "Lthpc2019serc"
    gpu_enabled: true
    description: "2080ti"

  - name: "GPU Server 2"
    host: "202.117.43.250"
    port: 22
    username: "serd"
    password: "Serd2021serd"
    gpu_enabled: true
    description: "3090"
```

---

## ⚠️ 注意事项

1. **密码安全**
   - 默认密码为 `admin123`，请务必修改
   - 密码存储在 `.env` 文件中，请妥善保管

2. **GPU 进程检测**
   - 需要服务器上安装了 `nvidia-smi`
   - 进程信息每次选择服务器时实时获取
   - 如果服务器上没有运行中的 GPU 进程，会显示空列表

3. **邮箱通知**
   - 需要正确配置 SMTP 服务器信息
   - Gmail 用户需要使用应用专用密码
   - 邮箱地址保存在本地，不会同步到其他设备

4. **服务器测试**
   - 测试结果仅表示 SSH 连接状态
   - 不代表 GPU、Docker 等功能可用性
   - 建议定期执行测试

---

## 🎉 总结

本次更新重点提升了系统的**安全性**、**易用性**和**智能化**：

| 功能 | 更新前 | 更新后 |
|-----|--------|--------|
| 删除用户 | 直接删除 | 需要密码验证 ✅ |
| 服务器测试 | 逐个测试 | 一键测试所有 ✅ |
| 创建任务 | 手动输入 PID | 自动检测并选择 ✅ |
| 填写邮箱 | 每次输入 | 自动记忆 ✅ |
| GPU 状态 | 需要单独查看 | 创建任务时自动显示 ✅ |

---

## 📞 获取帮助

如有问题，请：
1. 查看完整文档：`README.md`
2. 查看快速开始：`QUICK_START.md`
3. 提交 Issue 或联系管理员
