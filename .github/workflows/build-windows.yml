name: Build Windows EXE

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v3

    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: æ‰“åŒ…Windows EXE
      run: |
        pyinstaller build_windows.spec

    - name: å¤åˆ¶é¢å¤–æ–‡ä»¶
      run: |
        Copy-Item START_WINDOWS.bat dist\GPU-Server-Manager\
        Copy-Item README.md dist\GPU-Server-Manager\
        Copy-Item .env.example dist\GPU-Server-Manager\

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        Compress-Archive -Path dist\GPU-Server-Manager\* -DestinationPath GPU-Server-Manager-Windows.zip

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: GPU-Server-Manager-Windows
        path: GPU-Server-Manager-Windows.zip

    - name: åˆ›å»ºReleaseï¼ˆå¦‚æœæ˜¯æ ‡ç­¾è§¦å‘ï¼‰
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: GPU-Server-Manager-Windows.zip
        body: |
          ## GPU æœåŠ¡å™¨ç®¡ç†ç³»ç»Ÿ - Windowsç‰ˆæœ¬

          ### ğŸ“¦ å®‰è£…è¯´æ˜
          1. è§£å‹ GPU-Server-Manager-Windows.zip
          2. å¤åˆ¶ config\servers.yaml.example ä¸º config\servers.yaml
          3. ç¼–è¾‘ config\servers.yaml å¡«å…¥æ‚¨çš„æœåŠ¡å™¨ä¿¡æ¯
          4. åŒå‡» START_WINDOWS.bat å¯åŠ¨
          5. æµè§ˆå™¨è®¿é—® http://localhost:5000

          ### ğŸ”‘ ç™»å½•è®¤è¯
          - **ç®¡ç†å‘˜æ¨¡å¼**ï¼šå¯†ç  `GPU-admin@renzhihan-2025`ï¼ˆå¯ä¿®æ”¹ä»£ç è‡ªå®šä¹‰ï¼‰
          - **ç”¨æˆ·æ¨¡å¼**ï¼šæ— éœ€å¯†ç ï¼Œåªè¯»è®¿é—®

          ### ğŸ“š å®Œæ•´æ–‡æ¡£
          è¯¦è§ä»“åº“ [README.md](https://github.com/Renzhihan/gpu-server-manager/blob/main/README.md)
