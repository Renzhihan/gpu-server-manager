name: Build Windows EXE

on:
  push:
    branches:
      - main  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v3

    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: æ‰“åŒ…Windows EXE
      run: |
        pyinstaller build_windows.spec

    - name: å¤åˆ¶é¢å¤–æ–‡ä»¶åˆ°æ‰“åŒ…ç›®å½•
      run: |
        Copy-Item START_WINDOWS.bat dist\GPU-Server-Manager\
        Copy-Item README.md dist\GPU-Server-Manager\
        Copy-Item .env.example dist\GPU-Server-Manager\
        New-Item -ItemType Directory -Force -Path dist\GPU-Server-Manager\config
        Copy-Item config\servers.yaml.example dist\GPU-Server-Manager\config\

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆç›´æ¥ä¸Šä¼ ç›®å½•ï¼Œä¸é¢å¤–å‹ç¼©ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: GPU-Server-Manager-Windows
        path: dist/GPU-Server-Manager/

    - name: åˆ›å»ºReleaseå‹ç¼©åŒ…
      run: |
        Compress-Archive -Path dist\GPU-Server-Manager\* -DestinationPath GPU-Server-Manager-Windows.zip

    - name: ç”Ÿæˆç‰ˆæœ¬å·å’ŒReleaseä¿¡æ¯
      id: release_info
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # å¦‚æœæ˜¯tagè§¦å‘ï¼Œä½¿ç”¨tagä½œä¸ºç‰ˆæœ¬å·
          VERSION="${{ github.ref_name }}"
          IS_PRERELEASE="false"
        else
          # å¦‚æœæ˜¯pushè§¦å‘ï¼Œç”ŸæˆåŸºäºæ—¶é—´çš„ç‰ˆæœ¬å·
          VERSION="dev-$(date +'%Y%m%d-%H%M%S')"
          IS_PRERELEASE="true"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "commit_msg=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºæˆ–æ›´æ–°Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.version }}
        name: Release ${{ steps.release_info.outputs.version }}
        prerelease: ${{ steps.release_info.outputs.is_prerelease }}
        files: GPU-Server-Manager-Windows.zip
        body: |
          ## GPU æœåŠ¡å™¨ç®¡ç†ç³»ç»Ÿ - Windowsç‰ˆæœ¬

          **ç‰ˆæœ¬**: ${{ steps.release_info.outputs.version }}
          **æäº¤**: ${{ steps.release_info.outputs.commit_sha }}

          ### ğŸ“ æ›´æ–°å†…å®¹
          ```
          ${{ steps.release_info.outputs.commit_msg }}
          ```

          ### ğŸ“¦ å®‰è£…è¯´æ˜
          1. è§£å‹ GPU-Server-Manager-Windows.zip
          2. å¤åˆ¶ config\servers.yaml.example ä¸º config\servers.yaml
          3. ç¼–è¾‘ config\servers.yaml å¡«å…¥æ‚¨çš„æœåŠ¡å™¨ä¿¡æ¯
          4. åŒå‡» START_WINDOWS.bat å¯åŠ¨
          5. æµè§ˆå™¨è®¿é—® http://localhost:5000

          ### ğŸ”‘ ç™»å½•è®¤è¯
          - **ç®¡ç†å‘˜æ¨¡å¼**ï¼šå¯†ç  `admin`ï¼ˆå¯ä¿®æ”¹ä»£ç è‡ªå®šä¹‰ï¼‰
          - **ç”¨æˆ·æ¨¡å¼**ï¼šæ— éœ€å¯†ç ï¼Œåªè¯»è®¿é—®

          ### ğŸ“š å®Œæ•´æ–‡æ¡£
          è¯¦è§ä»“åº“ [README.md](https://github.com/Renzhihan/gpu-server-manager/blob/main/README.md)
