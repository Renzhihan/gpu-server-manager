{% extends "base.html" %}

{% block title %}服务器管理 - GPU 服务器管理系统{% endblock %}
{% block page_title %}服务器管理{% endblock %}

{% block content %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>提示:</strong> 服务器配置存储在 <code>config/servers.yaml</code> 文件中。修改后请点击"重新加载配置"按钮。
</div>

<div class="row mb-3">
    <div class="col-md-12 text-end">
        <button class="btn btn-success" onclick="testAllConnections()">
            <i class="bi bi-broadcast"></i> 一键测试所有连接
        </button>
        <button class="btn btn-primary" onclick="reloadConfig()">
            <i class="bi bi-arrow-clockwise"></i> 重新加载配置
        </button>
    </div>
</div>

<!-- 测试结果汇总 -->
<div id="testResultsSummary" style="display:none;" class="mb-3"></div>

<div id="serversContainer">
    <div class="text-center"><div class="spinner-border"></div></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadServers() {
    const container = document.getElementById('serversContainer');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

    const result = await utils.apiRequest('/api/servers');

    if (!result.success || result.servers.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">未配置服务器</div>';
        return;
    }

    const html = result.servers.map(server => `
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-${server.gpu_enabled ? 'gpu-card text-success' : 'server text-primary'}"></i>
                    ${server.name}
                    ${server.gpu_enabled ? '<span class="badge bg-success ms-2">GPU</span>' : ''}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>地址:</strong> ${server.host}:${server.port}</p>
                        <p><strong>描述:</strong> ${server.description || '无'}</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary btn-sm" onclick="testConnection('${server.name}')">
                            <i class="bi bi-plug"></i> 测试连接
                        </button>
                        <button class="btn btn-info btn-sm" onclick="viewServerInfo('${server.name}')">
                            <i class="bi bi-info-circle"></i> 系统信息
                        </button>
                    </div>
                </div>
                <div id="info-${server.name.replace(/\s/g, '-')}" class="mt-3"></div>
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
}

async function reloadConfig() {
    const result = await utils.apiRequest('/api/servers/reload', { method: 'POST' });
    if (result.success) {
        utils.showAlert(result.message, 'success');
        loadServers();
    } else {
        utils.showAlert('重新加载配置失败', 'danger');
    }
}

async function testConnection(serverName) {
    const containerId = 'info-' + serverName.replace(/\s/g, '-');
    const container = document.getElementById(containerId);
    container.innerHTML = '<div class="spinner-border spinner-border-sm"></div> 测试连接中...';

    const result = await utils.apiRequest(`/api/servers/${serverName}/test`);

    if (result.success) {
        container.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> 连接成功！
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> 连接失败: ${result.stderr}
            </div>
        `;
    }
}

async function viewServerInfo(serverName) {
    const containerId = 'info-' + serverName.replace(/\s/g, '-');
    const container = document.getElementById(containerId);
    container.innerHTML = '<div class="spinner-border spinner-border-sm"></div> 加载系统信息中...';

    const result = await utils.apiRequest(`/api/servers/${serverName}/info`);

    if (result.success) {
        const info = result.info;
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <tr><th>主机名</th><td>${info.hostname}</td></tr>
                    <tr><th>运行时间</th><td>${info.uptime}</td></tr>
                    <tr><th>内核版本</th><td>${info.kernel}</td></tr>
                    <tr><th>CPU</th><td>${info.cpu} (${info.cpu_count} 核)</td></tr>
                    <tr><th>内存</th><td>${info.memory_used} / ${info.memory}</td></tr>
                </table>
            </div>
        `;
    } else {
        container.innerHTML = `<div class="alert alert-danger">获取信息失败</div>`;
    }
}

async function testAllConnections() {
    const summaryContainer = document.getElementById('testResultsSummary');
    summaryContainer.style.display = 'block';
    summaryContainer.innerHTML = `
        <div class="card">
            <div class="card-body text-center">
                <div class="spinner-border text-primary"></div>
                <h5 class="mt-2">正在测试所有服务器连接...</h5>
                <p class="text-muted">请稍候，这可能需要几秒钟</p>
            </div>
        </div>
    `;

    const result = await utils.apiRequest('/api/servers/test-all');

    if (result.success) {
        const html = `
            <div class="card">
                <div class="card-header bg-${result.failed === 0 ? 'success' : 'warning'} text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-${result.failed === 0 ? 'check-circle' : 'exclamation-triangle'}"></i>
                        测试结果: ${result.connected}/${result.total} 台服务器连接成功
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>服务器</th>
                                    <th>地址</th>
                                    <th>状态</th>
                                    <th>错误信息</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.results.map(r => `
                                    <tr class="${r.success ? 'table-success' : 'table-danger'}">
                                        <td>${r.name}</td>
                                        <td>${r.host}</td>
                                        <td>
                                            ${r.success
                                                ? '<span class="badge bg-success"><i class="bi bi-check"></i> 成功</span>'
                                                : '<span class="badge bg-danger"><i class="bi bi-x"></i> 失败</span>'}
                                        </td>
                                        <td>${r.error || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        summaryContainer.innerHTML = html;
    } else {
        summaryContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> 测试失败: ${result.error}
            </div>
        `;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadServers();
});
</script>
{% endblock %}
