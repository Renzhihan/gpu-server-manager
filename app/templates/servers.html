{% extends "base.html" %}

{% block title %}服务器管理 - GPU 服务器管理系统{% endblock %}
{% block page_title %}服务器管理{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-6">
        <button class="btn btn-success" onclick="showAddServerModal()">
            <i class="bi bi-plus-circle"></i> 添加服务器
        </button>
        <div class="btn-group ms-2">
            <button class="btn btn-outline-primary" onclick="showImportModal()">
                <i class="bi bi-upload"></i> 导入
            </button>
            <button class="btn btn-outline-primary" onclick="exportServers()">
                <i class="bi bi-download"></i> 导出
            </button>
        </div>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-info" onclick="testAllConnections()">
            <i class="bi bi-broadcast"></i> 一键测试所有连接
        </button>
        <button class="btn btn-secondary" onclick="refreshConnections()">
            <i class="bi bi-arrow-clockwise"></i> 刷新连接池
        </button>
    </div>
</div>

<!-- 测试结果汇总 -->
<div id="testResultsSummary" style="display:none;" class="mb-3"></div>

<div id="serversContainer">
    <div class="text-center"><div class="spinner-border"></div></div>
</div>

<!-- 添加/编辑服务器 Modal -->
<div class="modal fade" id="serverModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serverModalTitle">
                    <i class="bi bi-server"></i> 添加服务器
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editServerOriginalName">
                <input type="hidden" id="isEditMode" value="false">

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="serverName" class="form-label">服务器名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="serverName" placeholder="例如: GPU Server 1">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="serverDescription" class="form-label">描述</label>
                            <input type="text" class="form-control" id="serverDescription" placeholder="例如: 3090">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="serverHost" class="form-label">主机地址 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="serverHost" placeholder="IP 或域名">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="serverPort" class="form-label">SSH 端口 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="serverPort" value="22">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="serverUsername" class="form-label">用户名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="serverUsername" placeholder="SSH 用户名">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">认证方式 <span class="text-danger">*</span></label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="authMethod" id="authPassword" value="password" checked onchange="toggleAuthMethod()">
                                    <label class="form-check-label" for="authPassword">密码</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="authMethod" id="authKey" value="key" onchange="toggleAuthMethod()">
                                    <label class="form-check-label" for="authKey">SSH 密钥</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="passwordAuth">
                    <div class="mb-3">
                        <label for="serverPassword" class="form-label">密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="serverPassword" placeholder="SSH 密码">
                    </div>
                </div>

                <div id="keyAuth" style="display:none;">
                    <div class="mb-3">
                        <label for="serverKeyFile" class="form-label">SSH 密钥文件路径 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="serverKeyFile" placeholder="例如: /root/.ssh/id_rsa">
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="serverGpuEnabled" checked>
                    <label class="form-check-label" for="serverGpuEnabled">
                        这是一台 GPU 服务器
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveServer()">
                    <i class="bi bi-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 导入 Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upload"></i> 导入服务器配置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">导入模式</label>
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="importMode" id="modeMerge" value="merge" checked>
                            <label class="form-check-label" for="modeMerge">
                                <strong>合并</strong> - 同名服务器跳过，保留现有配置
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="importMode" id="modeOverwrite" value="overwrite">
                            <label class="form-check-label" for="modeOverwrite">
                                <strong>覆盖</strong> - 同名服务器使用导入的配置覆盖
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="importMode" id="modeReplace" value="replace">
                            <label class="form-check-label text-danger" for="modeReplace">
                                <strong>替换</strong> - 删除所有现有配置，仅保留导入的
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="importYaml" class="form-label">YAML 配置内容</label>
                    <textarea class="form-control font-monospace" id="importYaml" rows="15" placeholder="servers:
  - name: GPU Server 1
    host: 192.168.1.100
    port: 22
    username: root
    password: your_password
    gpu_enabled: true
    description: 3090 服务器

  - name: GPU Server 2
    host: 192.168.1.101
    port: 22
    username: root
    key_file: /root/.ssh/id_rsa
    gpu_enabled: true
    description: A100 服务器"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">或选择文件导入</label>
                    <input type="file" class="form-control" id="importFile" accept=".yaml,.yml" onchange="loadImportFile()">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="importServers()">
                    <i class="bi bi-upload"></i> 导入
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 导出 Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-download"></i> 导出服务器配置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>安全提示:</strong> 默认导出不包含密码信息。如需包含密码，请勾选下方选项。
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="exportWithCredentials">
                    <label class="form-check-label" for="exportWithCredentials">
                        包含密码（<span class="text-danger">敏感信息</span>）
                    </label>
                </div>
                <textarea class="form-control font-monospace" id="exportYaml" rows="15" readonly></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="downloadExport()">
                    <i class="bi bi-download"></i> 下载文件
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="copyExport()">
                    <i class="bi bi-clipboard"></i> 复制
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleAuthMethod() {
    const authMethod = document.querySelector('input[name="authMethod"]:checked').value;
    document.getElementById('passwordAuth').style.display = authMethod === 'password' ? 'block' : 'none';
    document.getElementById('keyAuth').style.display = authMethod === 'key' ? 'block' : 'none';
}

function showAddServerModal() {
    document.getElementById('isEditMode').value = 'false';
    document.getElementById('serverModalTitle').innerHTML = '<i class="bi bi-server"></i> 添加服务器';

    // 重置表单
    document.getElementById('serverName').value = '';
    document.getElementById('serverDescription').value = '';
    document.getElementById('serverHost').value = '';
    document.getElementById('serverPort').value = '22';
    document.getElementById('serverUsername').value = '';
    document.getElementById('serverPassword').value = '';
    document.getElementById('serverKeyFile').value = '';
    document.getElementById('serverGpuEnabled').checked = true;
    document.getElementById('authPassword').checked = true;
    toggleAuthMethod();

    new bootstrap.Modal(document.getElementById('serverModal')).show();
}

function showEditServerModal(server) {
    document.getElementById('isEditMode').value = 'true';
    document.getElementById('editServerOriginalName').value = server.name;
    document.getElementById('serverModalTitle').innerHTML = '<i class="bi bi-pencil"></i> 编辑服务器';

    // 填充表单
    document.getElementById('serverName').value = server.name;
    document.getElementById('serverDescription').value = server.description || '';
    document.getElementById('serverHost').value = server.host;
    document.getElementById('serverPort').value = server.port;
    document.getElementById('serverUsername').value = server.username;
    document.getElementById('serverGpuEnabled').checked = server.gpu_enabled;

    // 认证方式
    if (server.key_file) {
        document.getElementById('authKey').checked = true;
        document.getElementById('serverKeyFile').value = server.key_file;
    } else {
        document.getElementById('authPassword').checked = true;
        document.getElementById('serverPassword').value = '';
        document.getElementById('serverPassword').placeholder = '留空则保持不变';
    }
    toggleAuthMethod();

    new bootstrap.Modal(document.getElementById('serverModal')).show();
}

async function saveServer() {
    const isEditMode = document.getElementById('isEditMode').value === 'true';
    const originalName = document.getElementById('editServerOriginalName').value;

    const authMethod = document.querySelector('input[name="authMethod"]:checked').value;
    const serverData = {
        name: document.getElementById('serverName').value.trim(),
        description: document.getElementById('serverDescription').value.trim(),
        host: document.getElementById('serverHost').value.trim(),
        port: parseInt(document.getElementById('serverPort').value),
        username: document.getElementById('serverUsername').value.trim(),
        gpu_enabled: document.getElementById('serverGpuEnabled').checked
    };

    // 验证必填字段
    if (!serverData.name || !serverData.host || !serverData.username) {
        utils.showAlert('请填写所有必填字段', 'warning');
        return;
    }

    // 添加认证信息
    if (authMethod === 'password') {
        const password = document.getElementById('serverPassword').value;
        if (!isEditMode && !password) {
            utils.showAlert('请输入密码', 'warning');
            return;
        }
        if (password) {
            serverData.password = password;
        }
    } else {
        serverData.key_file = document.getElementById('serverKeyFile').value.trim();
        if (!serverData.key_file) {
            utils.showAlert('请输入SSH密钥文件路径', 'warning');
            return;
        }
    }

    let result;
    if (isEditMode) {
        result = await utils.apiRequest(`/api/servers/${originalName}/update`, {
            method: 'PUT',
            body: JSON.stringify(serverData)
        });
    } else {
        result = await utils.apiRequest('/api/servers/add', {
            method: 'POST',
            body: JSON.stringify(serverData)
        });
    }

    if (result.success) {
        utils.showAlert(result.message, 'success');
        bootstrap.Modal.getInstance(document.getElementById('serverModal')).hide();
        loadServers();
    } else {
        utils.showAlert(result.error || '操作失败', 'danger');
    }
}

async function deleteServer(serverName) {
    if (!confirm(`确定要删除服务器 "${serverName}" 吗？此操作不可恢复。`)) {
        return;
    }

    const result = await utils.apiRequest(`/api/servers/${serverName}/delete`, {
        method: 'DELETE'
    });

    if (result.success) {
        utils.showAlert(result.message, 'success');
        loadServers();
    } else {
        utils.showAlert(result.error || '删除失败', 'danger');
    }
}

async function loadServers() {
    const container = document.getElementById('serversContainer');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

    const result = await utils.apiRequest('/api/servers');

    if (!result.success || result.servers.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>未配置服务器</strong>
                <p class="mb-2">您可以通过以下方式添加服务器：</p>
                <ul class="mb-0">
                    <li>点击 <strong>添加服务器</strong> 按钮手动添加</li>
                    <li>点击 <strong>导入</strong> 按钮从 YAML 文件批量导入</li>
                </ul>
            </div>`;
        return;
    }

    const html = result.servers.map(server => `
        <div class="card mb-3">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-${server.gpu_enabled ? 'gpu-card text-success' : 'server text-primary'}"></i>
                        ${server.name}
                        ${server.gpu_enabled ? '<span class="badge bg-success ms-2">GPU</span>' : ''}
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-warning" onclick='showEditServerModal(${JSON.stringify(server).replace(/'/g, "&#39;")})'>
                            <i class="bi bi-pencil"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteServer('${server.name}')">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>地址:</strong> ${server.host}:${server.port}</p>
                        <p><strong>用户名:</strong> ${server.username}</p>
                        <p><strong>描述:</strong> ${server.description || '无'}</p>
                        <p><strong>认证:</strong> ${server.key_file ? '<i class="bi bi-key"></i> SSH密钥' : '<i class="bi bi-lock"></i> 密码'}</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary btn-sm" onclick="testConnection('${server.name}')">
                            <i class="bi bi-plug"></i> 测试连接
                        </button>
                        <button class="btn btn-info btn-sm" onclick="viewServerInfo('${server.name}')">
                            <i class="bi bi-info-circle"></i> 系统信息
                        </button>
                    </div>
                </div>
                <div id="info-${server.name.replace(/\s/g, '-')}" class="mt-3"></div>
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
}

async function refreshConnections() {
    const result = await utils.apiRequest('/api/servers/reload', { method: 'POST' });
    if (result.success) {
        utils.showAlert(result.message, 'success');
    } else {
        utils.showAlert('刷新连接池失败', 'danger');
    }
}

async function testConnection(serverName) {
    const containerId = 'info-' + serverName.replace(/\s/g, '-');
    const container = document.getElementById(containerId);
    container.innerHTML = '<div class="spinner-border spinner-border-sm"></div> 测试连接中...';

    const result = await utils.apiRequest(`/api/servers/${serverName}/test`);

    if (result.success) {
        container.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> 连接成功！
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> 连接失败: ${result.stderr}
            </div>
        `;
    }
}

async function viewServerInfo(serverName) {
    const containerId = 'info-' + serverName.replace(/\s/g, '-');
    const container = document.getElementById(containerId);
    container.innerHTML = '<div class="spinner-border spinner-border-sm"></div> 加载系统信息中...';

    const result = await utils.apiRequest(`/api/servers/${serverName}/info`);

    if (result.success) {
        const info = result.info;
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <tr><th>主机名</th><td>${info.hostname}</td></tr>
                    <tr><th>运行时间</th><td>${info.uptime}</td></tr>
                    <tr><th>内核版本</th><td>${info.kernel}</td></tr>
                    <tr><th>CPU</th><td>${info.cpu} (${info.cpu_count} 核)</td></tr>
                    <tr><th>内存</th><td>${info.memory_used} / ${info.memory}</td></tr>
                </table>
            </div>
        `;
    } else {
        container.innerHTML = `<div class="alert alert-danger">获取信息失败</div>`;
    }
}

async function testAllConnections() {
    const summaryContainer = document.getElementById('testResultsSummary');
    summaryContainer.style.display = 'block';
    summaryContainer.innerHTML = `
        <div class="card">
            <div class="card-body text-center">
                <div class="spinner-border text-primary"></div>
                <h5 class="mt-2">正在测试所有服务器连接...</h5>
                <p class="text-muted">请稍候，这可能需要几秒钟</p>
            </div>
        </div>
    `;

    const result = await utils.apiRequest('/api/servers/test-all');

    if (result.success) {
        const html = `
            <div class="card">
                <div class="card-header bg-${result.failed === 0 ? 'success' : 'warning'} text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-${result.failed === 0 ? 'check-circle' : 'exclamation-triangle'}"></i>
                        测试结果: ${result.connected}/${result.total} 台服务器连接成功
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>服务器</th>
                                    <th>地址</th>
                                    <th>状态</th>
                                    <th>错误信息</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.results.map(r => `
                                    <tr class="${r.success ? 'table-success' : 'table-danger'}">
                                        <td>${r.name}</td>
                                        <td>${r.host}</td>
                                        <td>
                                            ${r.success
                                                ? '<span class="badge bg-success"><i class="bi bi-check"></i> 成功</span>'
                                                : '<span class="badge bg-danger"><i class="bi bi-x"></i> 失败</span>'}
                                        </td>
                                        <td>${r.error || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        summaryContainer.innerHTML = html;
    } else {
        summaryContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> 测试失败: ${result.error}
            </div>
        `;
    }
}

// ==================== 导入/导出功能 ====================

function showImportModal() {
    document.getElementById('importYaml').value = '';
    document.getElementById('importFile').value = '';
    document.getElementById('modeMerge').checked = true;
    new bootstrap.Modal(document.getElementById('importModal')).show();
}

function loadImportFile() {
    const file = document.getElementById('importFile').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('importYaml').value = e.target.result;
        };
        reader.readAsText(file);
    }
}

async function importServers() {
    const yamlContent = document.getElementById('importYaml').value.trim();
    const mode = document.querySelector('input[name="importMode"]:checked').value;

    if (!yamlContent) {
        utils.showAlert('请输入或选择 YAML 配置', 'warning');
        return;
    }

    if (mode === 'replace') {
        if (!confirm('⚠️ 替换模式将删除所有现有服务器配置！\n\n确定要继续吗？')) {
            return;
        }
    }

    const result = await utils.apiRequest('/api/servers/import', {
        method: 'POST',
        body: JSON.stringify({
            yaml_content: yamlContent,
            mode: mode
        })
    });

    if (result.success) {
        let msg = result.message;
        if (result.errors && result.errors.length > 0) {
            msg += '\n\n警告:\n' + result.errors.join('\n');
        }
        utils.showAlert(msg, 'success');
        bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
        loadServers();
    } else {
        utils.showAlert(result.error || '导入失败', 'danger');
    }
}

async function exportServers() {
    const includeCredentials = document.getElementById('exportWithCredentials')?.checked || false;
    const result = await utils.apiRequest(`/api/servers/export?include_credentials=${includeCredentials}`);

    if (result.success) {
        document.getElementById('exportYaml').value = result.yaml;
        new bootstrap.Modal(document.getElementById('exportModal')).show();
    } else {
        utils.showAlert(result.error || '导出失败', 'danger');
    }
}

// 监听导出选项变化
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('exportWithCredentials');
    if (checkbox) {
        checkbox.addEventListener('change', async function() {
            const result = await utils.apiRequest(`/api/servers/export?include_credentials=${this.checked}`);
            if (result.success) {
                document.getElementById('exportYaml').value = result.yaml;
            }
        });
    }
});

function downloadExport() {
    const yaml = document.getElementById('exportYaml').value;
    const blob = new Blob([yaml], { type: 'text/yaml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'servers.yaml';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    utils.showAlert('配置已下载', 'success');
}

function copyExport() {
    const yaml = document.getElementById('exportYaml').value;
    navigator.clipboard.writeText(yaml).then(() => {
        utils.showAlert('已复制到剪贴板', 'success');
    }).catch(() => {
        utils.showAlert('复制失败', 'danger');
    });
}

document.addEventListener('DOMContentLoaded', () => {
    loadServers();
});
</script>
{% endblock %}
